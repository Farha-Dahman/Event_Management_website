@page
@model EventManagement_Application.Pages.Organizer.Events.IndexModel
@{
    ViewData["Title"] = "Events";
}

@* <h1 class="clr-text py-2">Your Events</h1> *@

@* <form method="get"> *@
@*     <div class="row justify-content-between"> *@
@*         <div class="col-md-4"> *@
@*             <input type="text" name="SearchTerm" value="@Model.SearchTerm" class="form-control" placeholder="Search by category or location"> *@
@*         </div> *@

@*         <div class="col-md-2"> *@
@*             <button type="submit" class="btn bg-primary-color text-white">Search</button> *@
@*         </div> *@

@*         <div class="col-md-4"> *@
@*             <div class="input-group"> *@
@*                 <input type="date" name="SearchDate" value="@Model.SearchDate?.ToString("yyyy-MM-dd")" class="form-control"> *@
@*                 <span class="input-group-text" id="calendarIcon"> *@
@*                     <i class="fa fa-calendar"></i> *@
@*                 </span> *@
@*             </div> *@
@*         </div> *@

@*         <!-- Filter Icon --> *@
@*         <div class="col-md-1 justify-content-center align-items-center"> *@
@*             <button type="button" class="btn btn-outline-secondary d-flex p-1" onclick="toggleFilters()"> *@
@*                 <i class="fa-solid fa-filter px-1 mt-1"></i><h6 class="mt-1 px-1">Filter</h6> *@
@*             </button> *@
@*         </div> *@

@*         <!-- Filter Options (Initially Hidden) --> *@
@*         <div id="filterOptions" class="mt-3" style="display: none; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9;"> *@
@*             <div class="form-group"> *@
@*                 <label for="ticketType">Ticket Type</label> *@
@*                 <select id="ticketType" name="SelectedTicketType" class="form-control"> *@
@*                     <option value="">Select Ticket Type</option> *@
@*                     @foreach (var ticketType in Model.TicketTypes) *@
@*                     { *@
@*                         <option value="@ticketType">@ticketType</option> *@
@*                     } *@
@*                 </select> *@
@*             </div> *@

@*             <div class="form-group"> *@
@*                 <label for="eventMode">Event Mode</label> *@
@*                 <select id="eventMode" name="SelectedMode" class="form-control"> *@
@*                     <option value="">Select Event Mode</option> *@
@*                     <option value="Online">Online</option> *@
@*                     <option value="InPerson">In-person</option> *@
@*                 </select> *@
@*             </div> *@

@*             <!-- Done and Cancel buttons --> *@
@*             <div class="form-group"> *@
@*                 <button type="submit" id="doneButton" class="btn btn-success" >Done</button> *@
@*                 <button type="button" id="cancelButton" class="btn btn-danger" onclick="resetFilters()">Cancel</button> *@
@*             </div> *@
@*         </div> *@
@*     </div> *@
@* </form> *@

@* <!-- Events Grid --> *@
@* <div class="row row-cols-1 g-4 py-5">  *@
@*     @foreach (var eventItem in Model.Events) *@
@*     { *@
@*         <div class="col"> *@
@*             <div class="card event-card shadow border-0 overflow-visible d-flex flex-row align-items-stretch position-relative"> *@

@*                 <!-- Dropdown Menu (Top-Right) --> *@
@*                 <div class="dropdown position-absolute top-0 end-0 m-2"> *@
@*                     <button class="btn btn-light bg-white clr-text border-0 dropdown-toggle-split" *@
@*                             type="button" *@
@*                             data-bs-toggle="dropdown" *@
@*                             data-bs-popper="static"  *@
@*                             aria-expanded="false" *@
@*                             onclick="event.stopPropagation(); event.preventDefault();"> *@
@*                         <i class="fa-solid fa-ellipsis-vertical clr-text"></i> *@
@*                     </button> *@
@*                     <ul class="dropdown-menu show-on-top"> *@
@*                         <li><a class="dropdown-item clr-text" asp-page="./Details" asp-route-id="@eventItem.Id" onclick="event.stopPropagation(); event.preventDefault();"><i class="fa-solid fa-eye"></i> Details</a></li> *@
@*                         <li><a class="dropdown-item clr-text" asp-page="./Edit" asp-route-id="@eventItem.Id" onclick="event.stopPropagation(); event.preventDefault();"><i class="fa-solid fa-pen"></i> Edit</a></li> *@
@*                         <li><a class="dropdown-item clr-text" asp-page="./EventAnalytics" asp-route-eventId="@eventItem.Id" onclick="event.stopPropagation(); event.preventDefault();"><i class="fa-solid fa-chart-line"></i> Analytics</a></li> *@
@*                         <li><a class="dropdown-item clr-text" asp-page="./Attendees" asp-route-eventId="@eventItem.Id" onclick="event.stopPropagation(); event.preventDefault();"><i class="fa-solid fa-users"></i> Attendees</a></li> *@
@*                         <li><hr class="dropdown-divider"></li> *@
@*                         <li> *@
@*                             <button class="dropdown-item text-danger" onclick="event.stopPropagation(); event.preventDefault(); showDeleteModal(@eventItem.Id, '@eventItem.Title')"> *@
@*                                 <i class="fa-solid fa-trash"></i> Delete *@
@*                             </button> *@
@*                         </li> *@
@*                     </ul> *@
@*                 </div> *@

@*                 <!-- Event Image (Left Side) --> *@
@*                 <div class="event-img-wrapper flex-shrink-0"> *@
@*                     <img src="@(eventItem.EventImage != null ? "data:image/jpeg;base64," + Convert.ToBase64String(eventItem.EventImage) : "/images/default-image.jpg")" *@
@*                          class="event-img" *@
@*                          alt="Event Image"> *@
@*                 </div> *@

@*                 <!-- Event Details (Right Side, Bottom-Aligned) --> *@
@*                 <div class="card-body d-flex flex-column justify-content-between w-100"> *@
@*                     <div> *@
@*                         <h5 class="card-title">@eventItem.Title</h5> *@
@*                         <p class="text-muted">@eventItem.Category</p> *@
@*                         <p><i class="fa-solid fa-calendar"></i> @eventItem.EventDate.ToString("yyyy-MM-dd HH:mm")</p> *@
@*                         <p><i class="fa-solid fa-map-marker-alt"></i> @eventItem.Location</p> *@
@*                     </div> *@
@*                 </div> *@
@*             </div> *@
@*         </div> *@
@*     } *@
@* </div> *@

@* <!-- Delete Confirmation Modal --> *@
@* <div id="deleteModal" class="modal" tabindex="-1"> *@
@*     <div class="modal-dialog"> *@
@*         <div class="modal-content"> *@
@*             <div class="modal-header"> *@
@*                 <h5 class="modal-title">Confirm Deletion</h5> *@
@*                 <button type="button" class="btn-close" data-bs-dismiss="modal"></button> *@
@*             </div> *@
@*             <div class="modal-body"> *@
@*                 <p>Are you sure you want to delete this event?</p> *@
@*             </div> *@
@*             <div class="modal-footer"> *@
@*                 <button id="confirmDeleteButton" class="btn btn-danger">Delete</button> *@
@*                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> *@
@*             </div> *@
@*         </div> *@
@*     </div> *@
@* </div> *@

@* <a asp-page="./Create" class="btn btn-success">Create New Event</a> *@

@* <script> *@
@*     document.getElementById("calendarIcon").addEventListener("click", function() { *@
@*         document.getElementById("datePicker").showPicker(); *@
@*     }); *@

@*      function toggleFilters() { *@
@*         const filterOptions = document.getElementById('filterOptions'); *@
@*         filterOptions.style.display = filterOptions.style.display === 'none' ? 'block' : 'none'; *@
@*     } *@

@*     // Reset filters to default state (Cancel action) *@
@*     function resetFilters() { *@
@*         document.getElementById('eventMode').value = ''; *@
@*         document.getElementById('ticketType').value = ''; *@

@*         // Reset the URL (remove query params) to show all events *@
@*         history.pushState(null, "", window.location.pathname); *@
@*     } *@

@*     let eventIdToDelete = null; *@

@*     function showDeleteModal(eventId) { *@
@*         eventIdToDelete = eventId; *@
@*         $("#deleteModal").modal("show"); *@
@*     } *@

@*     document.getElementById("confirmDeleteButton").addEventListener("click", function () { *@
@*         if (eventIdToDelete) { *@
@*             fetch(`/Organizer/Events/Index?handler=Delete&id=${eventIdToDelete}`, { *@
@*                 method: "POST", *@
@*                 headers: { *@
@*                     "Content-Type": "application/json", *@
@*                     "RequestVerificationToken": document.querySelector("input[name='__RequestVerificationToken']").value *@
@*                 } *@
@*             }) *@
@*             .then(response => response.json()) *@
@*             .then(data => { *@
@*                 if (data.success) { *@
@*                     location.reload(); *@
@*                 } else { *@
@*                     alert("Error deleting the event."); *@
@*                 } *@
@*             }) *@
@*             .catch(error => console.error("Error:", error)); *@
@*         } *@
@*     }); *@
@*     // close delete confirmation *@
@*     document.querySelector(".close").addEventListener("click", function () { *@
@*         $("#deleteModal").modal("hide"); *@
@*     }); *@
@* </script> *@


<h1 class="clr-text py-2">Your Events</h1>

<!-- Search and Filter Form -->
<form method="get">
    <div class="row justify-content-between">
        <div class="col-md-4">
            <input type="text" name="SearchTerm" value="@Model.SearchTerm" class="form-control" placeholder="Search by category or location">
        </div>

        <div class="col-md-4">
            <div class="input-group">
                <input type="date" name="SearchDate" value="@Model.SearchDate?.ToString("yyyy-MM-dd")" class="form-control">
                <span class="input-group-text" id="calendarIcon">
                    <i class="fa fa-calendar"></i>
                </span>
            </div>
        </div>

        <div class="col-md-2">
            <button type="submit" class="btn bg-primary-color text-white">Search</button>
        </div>

        <!-- Filter Icon -->
        <div class="col-md-1 justify-content-center align-items-center">
            <button type="button" class="btn btn-outline-secondary d-flex p-1" onclick="toggleFilters()">
                <i class="fa-solid fa-filter px-1 mt-1"></i><h6 class="mt-1 px-1">Filter</h6>
            </button>
        </div>

        <!-- Filter Options (Initially Hidden) -->
        <div id="filterOptions" class="mt-3" style="display: none; padding: 15px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <div class="form-group">
                <label for="ticketType">Ticket Type</label>
                <select id="ticketType" name="SelectedTicketType" class="form-control">
                    <option value="">Select Ticket Type</option>
                    @foreach (var ticketType in Model.TicketTypes)
                    {
                        <option value="@ticketType">@ticketType</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="eventMode">Event Mode</label>
                <select id="eventMode" name="SelectedMode" class="form-control">
                    <option value="">Select Event Mode</option>
                    <option value="Online">Online</option>
                    <option value="InPerson">In-person</option>
                </select>
            </div>

            <!-- Done and Cancel buttons -->
            <div class="form-group">
                <button type="submit" id="doneButton" class="btn btn-success">Done</button>
                <button type="button" id="cancelButton" class="btn btn-danger" onclick="resetFilters()">Cancel</button>
            </div>
        </div>
    </div>
</form>

<!-- Events Grid -->
<div class="row row-cols-1 g-4 py-5">
    @foreach (var eventItem in Model.Events)
    {
        <div class="col">
            <div class="card event-card shadow border-0 overflow-visible d-flex flex-row align-items-stretch position-relative"
                 onclick="window.location.href='/Organizer/Events/Details?id=@eventItem.Id';"
                 style="cursor: pointer;">

                <!-- Dropdown Menu (Top-Right) -->
                <div class="dropdown position-absolute top-0 end-0 m-2">
                    <button class="btn btn-light bg-white clr-text border-0 dropdown-toggle-split"
                            type="button"
                            data-bs-toggle="dropdown"
                            data-bs-popper="static"
                            aria-expanded="false"
                            onclick="event.stopPropagation();">
                        <i class="fa-solid fa-ellipsis-vertical clr-text"></i>
                    </button>
                    <ul class="dropdown-menu show-on-top">
                        <li><a class="dropdown-item clr-text" asp-page="./Edit" asp-route-id="@eventItem.Id"><i class="fa-solid fa-pen"></i> Edit</a></li>
                        <li><a class="dropdown-item clr-text" asp-page="./EventAnalytics" asp-route-eventId="@eventItem.Id"><i class="fa-solid fa-chart-line"></i> Analytics</a></li>
                        <li><a class="dropdown-item clr-text" asp-page="./Attendees" asp-route-eventId="@eventItem.Id"><i class="fa-solid fa-users"></i> Attendees</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item text-danger" onclick="event.stopPropagation(); showDeleteModal(@eventItem.Id, '@eventItem.Title')">
                                <i class="fa-solid fa-trash"></i> Delete
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Event Image (Left Side) -->
                <div class="event-img-wrapper flex-shrink-0">
                    <img src="@(eventItem.EventImage != null ? "data:image/jpeg;base64," + Convert.ToBase64String(eventItem.EventImage) : "/images/default-image.jpg")"
                         class="event-img"
                         alt="Event Image">
                </div>

                <!-- Event Details (Right Side, Bottom-Aligned) -->
                <div class="card-body d-flex flex-column justify-content-between w-100">
                    <div>
                        <h5 class="card-title">@eventItem.Title</h5>
                        <p class="text-muted">@eventItem.Category</p>
                        <p><i class="fa-solid fa-calendar"></i> @eventItem.EventDate.ToString("yyyy-MM-dd HH:mm")</p>
                        <p><i class="fa-solid fa-map-marker-alt"></i> @eventItem.Location</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this event?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmDeleteButton" class="btn btn-danger">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<a asp-page="./Create" class="btn btn-success">Create New Event</a>

<script>
    document.getElementById("calendarIcon").addEventListener("click", function() {
        document.getElementById("datePicker").showPicker();
    });

    function toggleFilters() {
        const filterOptions = document.getElementById('filterOptions');
        filterOptions.style.display = filterOptions.style.display === 'none' ? 'block' : 'none';
    }

    // Reset filters to default state (Cancel action)
    function resetFilters() {
        document.getElementById('eventMode').value = '';
        document.getElementById('ticketType').value = '';

        // Reset the URL (remove query params) to show all events
        history.pushState(null, "", window.location.pathname);
    }

    let eventIdToDelete = null;

    function showDeleteModal(eventId) {
        eventIdToDelete = eventId;
        $("#deleteModal").modal("show");
    }

    document.getElementById("confirmDeleteButton").addEventListener("click", function () {
        if (eventIdToDelete) {
            fetch(`/Organizer/Events/Index?handler=Delete&id=${eventIdToDelete}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": document.querySelector("input[name='__RequestVerificationToken']").value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert("Error deleting the event.");
                }
            })
            .catch(error => console.error("Error:", error));
        }
    });

    // Close delete confirmation
    document.querySelector(".close").addEventListener("click", function () {
        $("#deleteModal").modal("hide");
    });
</script>
